generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("post_purchase_app_DATABASE_URL")
}

model Session {
  id            String    @id
  shop          String
  state         String
  isOnline      Boolean   @default(false)
  scope         String?
  expires       DateTime?
  accessToken   String
  userId        BigInt?
  firstName     String?
  lastName      String?
  email         String?
  accountOwner  Boolean   @default(false)
  locale        String?
  collaborator  Boolean?  @default(false)
  emailVerified Boolean?  @default(false)
}

model Subscription {
  id                      Int         @id @default(autoincrement())
  shopify_url             String      @unique
  shopify_subscription_id String?
  charge_id               String?
  plan_id                 String      @default("free")
  plan_name               String      @default("Free")
  plan_price              Float       @default(0)
  max_active_offers       Int         @default(2)
  max_impressions_monthly Int         @default(100)
  is_active               Boolean     @default(false)
  started_at              DateTime    @default(now())
  expires_at              DateTime?
  createdAt               DateTime    @default(now())
  updatedAt               DateTime    @updatedAt
  analytics               Analytics[]
  offers                  Offer[]
}

model Offer {
  id                 String            @id @default(cuid())
  shopify_url        String
  name               String
  description        String?
  status             String            @default("active")
  discount_type      String
  discount_value     Float
  offer_title        String
  offer_description  String?
  button_text        String            @default("Add to Order")
  limit_per_customer Int               @default(1)
  total_limit        Int?
  expiry_date        DateTime?
  schedule_start     DateTime?
  enable_ab_test     Boolean           @default(false)
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  analytics          Analytics[]
  events             OfferEvent[]
  subscription       Subscription      @relation(fields: [shopify_url], references: [shopify_url])
  purchasedProducts  PurchasedProduct[]
  products           OfferProduct[]
}

model PurchasedProduct {
  id                 String @id @default(cuid())
  offer_id           String
  shopify_product_id String
  shopify_variant_id String?
  product_title      String
  variant_title      String?
  product_price      String
  variant_price      String?
  image_url          String?
  variants_count     Int    @default(1)
  createdAt          DateTime @default(now())
  offer              Offer @relation(fields: [offer_id], references: [id], onDelete: Cascade)

  @@unique([offer_id, shopify_product_id, shopify_variant_id])
}

model OfferProduct {
  id                 String   @id @default(cuid())
  offer_id           String
  shopify_product_id String
  shopify_variant_id String?
  product_title      String
  variant_title      String?
  product_price      String
  variant_price      String?
  image_url          String?
  variants_count     Int      @default(1)
  createdAt          DateTime @default(now())
  offer              Offer    @relation(fields: [offer_id], references: [id], onDelete: Cascade)

  @@unique([offer_id, shopify_product_id, shopify_variant_id])
}

model Analytics {
  id              String       @id @default(cuid())
  shopify_url     String
  offer_id        String?
  date            DateTime     @default(now())
  impressions     Int          @default(0)
  views           Int          @default(0)
  clicks          Int          @default(0)
  conversions     Int          @default(0)
  declines        Int          @default(0)
  revenue         Float        @default(0)
  conversion_rate Float        @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  offer           Offer?       @relation(fields: [offer_id], references: [id], onDelete: Cascade)
  subscription    Subscription @relation(fields: [shopify_url], references: [shopify_url])
}

model OfferEvent {
  id                String   @id @default(cuid())
  shopify_url       String
  offer_id          String?
  event_type        String   // 'impression', 'view', 'accept', 'decline'
  customer_id       String?
  order_id          String?
  product_id        String?
  variant_id        String?
  revenue_amount    Float?   @default(0)
  discount_amount   Float?   @default(0)
  session_id        String?
  user_agent        String?
  ip_address        String?
  referrer          String?
  event_data        Json?    // Additional event metadata
  createdAt         DateTime @default(now())
  offer             Offer?   @relation(fields: [offer_id], references: [id], onDelete: Cascade)

  @@index([shopify_url, event_type, createdAt])
  @@index([offer_id, event_type, createdAt])
}
